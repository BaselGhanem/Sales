<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة المبيعات الذكي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { primary: '#099999' }
                }
            }
        }
    </script>
    <style>
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-primary">جاري جلب بيانات المندوبين...</p>
        <p class="text-xs text-gray-400 mt-2">Connecting to GitHub via jsDelivr</p>
    </div>

    <nav class="bg-white shadow-sm sticky top-0 z-40 p-4 border-b">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-primary rounded-lg text-white font-bold">BG</div>
                <h1 class="text-xl font-extrabold text-primary">لوحة مبيعات باسل غانم</h1>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <select id="repSelector" onchange="renderUI()" class="flex-1 md:w-64 p-2 border rounded-lg bg-gray-50 font-bold focus:ring-2 focus:ring-primary outline-none"></select>
                <div class="flex bg-gray-200 p-1 rounded-lg">
                    <button onclick="setPeriod('MTD')" id="btn-mtd" class="px-4 py-1 rounded-md text-sm font-bold bg-white shadow-sm text-primary">MTD</button>
                    <button onclick="setPeriod('YTD')" id="btn-ytd" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500">YTD</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 space-y-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-primary">
                <p class="text-gray-400 text-xs font-bold">صافي المبيعات</p>
                <p id="stat-sales" class="text-xl font-black text-slate-700">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-orange-500">
                <p class="text-gray-400 text-xs font-bold">الكمية (Net Goods)</p>
                <p id="stat-qty" class="text-xl font-black text-slate-700">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-blue-500">
                <p class="text-gray-400 text-xs font-bold">أعلى منطقة</p>
                <p id="stat-area" class="text-sm font-black text-slate-700 truncate">--</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-purple-500">
                <p class="text-gray-400 text-xs font-bold">أعلى عميل</p>
                <p id="stat-cust" class="text-sm font-black text-slate-700 truncate">--</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-sm h-80">
                <h3 class="font-bold text-sm mb-4">الأداء الزمني</h3>
                <canvas id="mainChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm h-80">
                <h3 class="font-bold text-sm mb-4">توزيع المناطق</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold">تفاصيل الأصناف</h3>
                <span id="rowCount" class="text-xs bg-primary text-white px-2 py-1 rounded-full">0 صنف</span>
            </div>
            <div class="overflow-x-auto max-h-96">
                <table class="w-full text-right text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-3">اسم الصنف (Item Name)</th>
                            <th class="p-3 text-center">الكمية</th>
                            <th class="p-3 text-center">المبيعات</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // الرابط باستخدام CDN لتخطي CORS
        const URL = 'https://cdn.jsdelivr.net/gh/BaselGhanem/Sales@main/Daily%20Sales%20Report.xlsx';
        
        let rawData = [];
        let period = 'MTD';
        let charts = {};

        // محرك البحث التلقائي عن الأعمدة (Auto-Mapping)
        const getCol = (row, keywords) => {
            const keys = Object.keys(row);
            return keys.find(k => keywords.some(kw => k.toLowerCase().includes(kw.toLowerCase()))) || keys[0];
        };

        window.onload = async () => {
            try {
                // إضافة timestamp للرابط لمنع الكاش (التخزين المؤقت)
                const finalUrl = `${URL}?t=${new Date().getTime()}`;
                const res = await fetch(finalUrl);
                if (!res.ok) throw new Error();
                
                const ab = await res.arrayBuffer();
                const wb = XLSX.read(ab, { type: 'array' });
                rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                init();
            } catch (e) {
                document.getElementById('loader').innerHTML = `
                    <div class="text-center p-6">
                        <p class="text-red-500 font-bold">فشل الاتصال بـ GitHub</p>
                        <p class="text-xs text-gray-500 mt-2">تأكد من رفع الملف وجعله Public</p>
                        <button onclick="location.reload()" class="mt-4 bg-primary text-white px-6 py-2 rounded-full">إعادة محاولة</button>
                    </div>`;
            }
        };

        function init() {
            document.getElementById('loader').style.display = 'none';
            // البحث عن عمود المندوب (قد يكون Salesman أو Detailman Name)
            const repCol = getCol(rawData[0], ['Salesman', 'Detailman', 'Salesrep']);
            const reps = [...new Set(rawData.map(r => r[repCol]))].filter(Boolean).sort();
            
            const sel = document.getElementById('repSelector');
            sel.innerHTML = reps.map(r => `<option value="${r}">${r}</option>`).join('');
            
            renderUI();
        }

        window.setPeriod = (p) => {
            period = p;
            document.getElementById('btn-mtd').className = p === 'MTD' ? 'px-4 py-1 rounded-md text-sm font-bold bg-white shadow-sm text-primary' : 'px-4 py-1 rounded-md text-sm font-bold text-gray-500';
            document.getElementById('btn-ytd').className = p === 'YTD' ? 'px-4 py-1 rounded-md text-sm font-bold bg-white shadow-sm text-primary' : 'px-4 py-1 rounded-md text-sm font-bold text-gray-500';
            renderUI();
        };

        function renderUI() {
            const selectedRep = document.getElementById('repSelector').value;
            const now = new Date();
            
            // تحديد أسماء الأعمدة ديناميكياً بناءً على ما أرسلته
            const c = {
                rep: getCol(rawData[0], ['Salesman', 'Detailman']),
                date: getCol(rawData[0], ['Transaction Date', 'Date']),
                sales: getCol(rawData[0], ['Sales', 'Value']),
                qty: getCol(rawData[0], ['Net Goods', 'Goods Qty']),
                item: getCol(rawData[0], ['Item Name', 'Description']),
                area: getCol(rawData[0], ['Area Name']),
                cust: getCol(rawData[0], ['Cust Name'])
            };

            const filtered = rawData.filter(r => {
                if (r[c.rep] !== selectedRep) return false;
                const d = new Date(r[c.date]);
                if (isNaN(d)) return false;
                const sameYear = d.getFullYear() === now.getFullYear();
                const sameMonth = d.getMonth() === now.getMonth();
                return period === 'MTD' ? (sameYear && sameMonth) : sameYear;
            });

            // الحسابات
            let totalSales = 0, totalQty = 0;
            const items = {}, areas = {}, daily = {}, customers = {};

            filtered.forEach(r => {
                const s = parseFloat(r[c.sales]) || 0;
                const q = parseFloat(r[c.qty]) || 0;
                const dateKey = r[c.date];
                
                totalSales += s;
                totalQty += q;
                
                areas[r[c.area]] = (areas[r[c.area]] || 0) + s;
                daily[dateKey] = (daily[dateKey] || 0) + s;
                customers[r[c.cust]] = (customers[r[c.cust]] || 0) + s;

                if (!items[r[c.item]]) items[r[c.item]] = { q: 0, s: 0 };
                items[r[c.item]].q += q;
                items[r[c.item]].s += s;
            });

            // تحديث الأرقام
            document.getElementById('stat-sales').innerText = Math.round(totalSales).toLocaleString();
            document.getElementById('stat-qty').innerText = Math.round(totalQty).toLocaleString();
            
            const topArea = Object.entries(areas).sort((a,b) => b[1]-a[1])[0];
            document.getElementById('stat-area').innerText = topArea ? topArea[0] : '--';

            const topCust = Object.entries(customers).sort((a,b) => b[1]-a[1])[0];
            document.getElementById('stat-cust').innerText = topCust ? topCust[0] : '--';

            // تحديث الجدول
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = Object.entries(items).sort((a,b) => b[1].s - a[1].s).map(([name, data]) => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-bold text-slate-600">${name}</td>
                    <td class="p-3 text-center text-orange-600 font-bold">${Math.round(data.q)}</td>
                    <td class="p-3 text-center text-primary font-bold">${Math.round(data.s).toLocaleString()}</td>
                </tr>
            `).join('');
            document.getElementById('rowCount').innerText = Object.keys(items).length + " صنف";

            // الرسوم البيانية
            updateCharts(daily, areas);
        }

        function updateCharts(daily, areas) {
            if (charts.main) charts.main.destroy();
            if (charts.pie) charts.pie.destroy();

            const ctx1 = document.getElementById('mainChart').getContext('2d');
            charts.main = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Object.keys(daily),
                    datasets: [{ label: 'المبيعات اليومية', data: Object.values(daily), borderColor: '#099999', backgroundColor: 'rgba(9,153,153,0.1)', fill: true, tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctx2 = document.getElementById('pieChart').getContext('2d');
            charts.pie = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(areas),
                    datasets: [{ data: Object.values(areas), backgroundColor: ['#099999', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
    </script>
</body>
</html>
