<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة المبيعات الاحترافية</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { 
                        brand: {
                            DEFAULT: '#2563eb', // أزرق ملكي
                            dark: '#1e40af',
                            light: '#dbeafe'
                        },
                        accent: '#f59e0b' // برتقالي للتنبيهات
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        /* شريط التمرير المخصص */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .stat-card { transition: transform 0.2s; }
        .stat-card:active { transform: scale(0.98); }

        /* أنيميشن التحميل */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #2563eb;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 antialiased pb-20 md:pb-10">

    <div id="loadingScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white transition-opacity duration-500">
        <span class="loader mb-4"></span>
        <h2 class="text-xl font-bold text-slate-700">جاري الاتصال بـ GitHub...</h2>
        <p class="text-sm text-slate-400 mt-2">يتم تحليل ملف المبيعات</p>
    </div>

    <nav class="glass-header sticky top-0 z-40 px-4 py-3">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="w-10 h-10 bg-brand rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">لوحة التحكم</h1>
                    <p class="text-xs text-slate-500">Sales Dashboard</p>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row w-full md:w-auto gap-3">
                <div class="flex bg-slate-100 p-1 rounded-xl w-full sm:w-auto">
                    <button onclick="switchPeriod('MTD')" id="btn-mtd" class="flex-1 px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-brand">
                        MTD (شهري)
                    </button>
                    <button onclick="switchPeriod('YTD')" id="btn-ytd" class="flex-1 px-6 py-2 rounded-lg text-sm font-bold text-slate-500 transition-all hover:text-slate-700">
                        YTD (سنوي)
                    </button>
                </div>

                <div class="relative w-full sm:w-64">
                    <select id="repSelect" onchange="updateDashboard()" class="w-full appearance-none bg-white border border-slate-200 text-slate-700 py-2.5 px-4 pr-8 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand/20 font-semibold shadow-sm">
                        <option value="">جاري التحميل...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center px-3 text-slate-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        
        <div class="relative overflow-hidden bg-gradient-to-br from-brand to-blue-700 rounded-2xl shadow-xl text-white p-6 md:p-10">
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <span id="periodBadge" class="inline-block px-3 py-1 bg-white/20 rounded-full text-xs font-medium backdrop-blur-sm mb-3">تقرير الشهر الحالي</span>
                    <h2 class="text-3xl md:text-4xl font-bold tracking-tight" id="headerName">--</h2>
                    <p class="text-blue-100 mt-1 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span id="topAreaText">--</span>
                    </p>
                </div>
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur-md border border-white/10 min-w-[180px]">
                    <p class="text-sm text-blue-200">إجمالي المبيعات</p>
                    <p class="text-3xl font-bold font-mono mt-1" id="totalSales">0</p>
                </div>
            </div>
            
            <div class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30"></div>
            <div class="absolute bottom-0 left-0 -mb-20 -ml-20 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-30"></div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="stat-card bg-white p-5 rounded-2xl shadow-card border-b-4 border-emerald-500">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">صافي الكمية</p>
                <p class="text-2xl font-bold text-emerald-600 mt-1" id="totalQty">0</p>
            </div>
            <div class="stat-card bg-white p-5 rounded-2xl shadow-card border-b-4 border-amber-500">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">عدد الفواتير</p>
                <p class="text-2xl font-bold text-amber-600 mt-1" id="invoiceCount">0</p>
            </div>
            <div class="stat-card bg-white p-5 rounded-2xl shadow-card border-b-4 border-indigo-500 col-span-2 md:col-span-2">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">أعلى عميل شراءً</p>
                <div class="flex justify-between items-end mt-1">
                    <p class="text-lg font-bold text-slate-800 truncate w-2/3" id="topCustomer">--</p>
                    <p class="text-sm font-bold text-indigo-600" id="topCustomerVal">0</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-soft lg:col-span-2">
                <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
                    <span class="w-1 h-6 bg-brand rounded-full"></span>
                    تحليل الأداء اليومي
                </h3>
                <div class="relative h-64 w-full">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-soft">
                <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
                    <span class="w-1 h-6 bg-accent rounded-full"></span>
                    توزيع المناطق
                </h3>
                <div class="relative h-64 w-full flex justify-center">
                    <canvas id="areaChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-soft overflow-hidden flex flex-col max-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                    <h3 class="font-bold text-slate-700">الأصناف الأكثر مبيعاً</h3>
                </div>
                <div class="overflow-y-auto p-0">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-50 text-slate-500 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 font-semibold">الصنف</th>
                                <th class="px-4 py-3 font-semibold text-center">الكمية</th>
                                <th class="px-4 py-3 font-semibold text-left">القيمة</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="productsTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-soft overflow-hidden flex flex-col max-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                    <h3 class="font-bold text-slate-700">قائمة العملاء</h3>
                </div>
                <div class="overflow-y-auto p-0">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-50 text-slate-500 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 font-semibold">العميل</th>
                                <th class="px-4 py-3 font-semibold text-left">المبيعات</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="customersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        // رابط الملف المباشر (Raw)
        const EXCEL_URL = 'https://github.com/BaselGhanem/Sales/raw/main/Daily%20Sales%20Report.xlsx';

        // أسماء الأعمدة في ملف الإكسل
        const COLS = {
            REP: "Salesman",
            DATE: "Date",
            SALES: "Sales",
            QTY: "Net Goods",
            AREA: "Area Name",
            CUST: "Cust Name",
            ITEM: "Item Name"
        };

        let allData = [];
        let currentPeriod = 'MTD';
        let charts = { sales: null, area: null };

        // 1. التشغيل عند التحميل
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(EXCEL_URL);
                if (!response.ok) throw new Error("فشل تحميل الملف من GitHub");
                
                const buffer = await response.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // تحويل البيانات إلى JSON
                allData = XLSX.utils.sheet_to_json(firstSheet, { raw: false }); // raw:false لقرائتها كنصوص أولاً لتفادي مشاكل التاريخ
                
                if (allData.length === 0) throw new Error("الملف فارغ");

                populateRepList();
                document.getElementById('loadingScreen').classList.add('opacity-0');
                setTimeout(() => document.getElementById('loadingScreen').remove(), 500);
                
                // اختيار أول مندوب تلقائياً
                const firstRep = document.getElementById('repSelect').options[0].value;
                updateDashboard();

            } catch (err) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="text-center p-6 bg-red-50 rounded-xl border border-red-100">
                        <p class="text-red-600 font-bold text-lg mb-2">خطأ في التحميل</p>
                        <p class="text-red-500 text-sm">${err.message}</p>
                    </div>`;
            }
        });

        // 2. تعبئة القائمة
        function populateRepList() {
            const reps = [...new Set(allData.map(d => d[COLS.REP]))].filter(Boolean).sort();
            const select = document.getElementById('repSelect');
            select.innerHTML = reps.map(r => `<option value="${r}">${r}</option>`).join('');
        }

        // 3. تبديل الفترة الزمنية
        window.switchPeriod = (period) => {
            currentPeriod = period;
            const btnMtd = document.getElementById('btn-mtd');
            const btnYtd = document.getElementById('btn-ytd');
            
            if (period === 'MTD') {
                btnMtd.className = "flex-1 px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-brand";
                btnYtd.className = "flex-1 px-6 py-2 rounded-lg text-sm font-bold text-slate-500 transition-all hover:text-slate-700";
                document.getElementById('periodBadge').textContent = "تقرير الشهر الحالي";
            } else {
                btnMtd.className = "flex-1 px-6 py-2 rounded-lg text-sm font-bold text-slate-500 transition-all hover:text-slate-700";
                btnYtd.className = "flex-1 px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-brand";
                document.getElementById('periodBadge').textContent = "تقرير السنة الحالية";
            }
            updateDashboard();
        }

        // 4. معالجة التاريخ بذكاء
        function parseDate(dateStr) {
            // التعامل مع تنسيقات مختلفة
            if (!dateStr) return null;
            const d = new Date(dateStr);
            if (!isNaN(d)) return d;
            
            // محاولة يدوية لـ DD/MM/YYYY
            const parts = dateStr.split('/');
            if (parts.length === 3) return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
            
            return null;
        }

        // 5. تحديث اللوحة
        window.updateDashboard = () => {
            const selectedRep = document.getElementById('repSelect').value;
            if (!selectedRep) return;

            const now = new Date(); // التاريخ الحالي للجهاز
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            // الفلترة
            const filtered = allData.filter(row => {
                if (row[COLS.REP] !== selectedRep) return false;
                
                const rowDate = parseDate(row[COLS.DATE]);
                if (!rowDate) return false;

                const isSameYear = rowDate.getFullYear() === currentYear;
                const isSameMonth = rowDate.getMonth() === currentMonth;

                return currentPeriod === 'MTD' ? (isSameYear && isSameMonth) : isSameYear;
            });

            // الحسابات
            let totalSales = 0, totalQty = 0;
            let areas = {}, dates = {}, products = {}, customers = {};

            filtered.forEach(row => {
                // تنظيف الأرقام (إزالة الفواصل والنصوص)
                const sales = parseFloat(String(row[COLS.SALES]).replace(/,/g, '')) || 0;
                const qty = parseFloat(String(row[COLS.QTY]).replace(/,/g, '')) || 0;
                
                totalSales += sales;
                totalQty += qty;

                // التجميع
                areas[row[COLS.AREA]] = (areas[row[COLS.AREA]] || 0) + sales;
                
                const dateKey = row[COLS.DATE]; // استخدام النص الأصلي للعرض
                dates[dateKey] = (dates[dateKey] || 0) + sales;

                const prod = row[COLS.ITEM];
                if (!products[prod]) products[prod] = { sales: 0, qty: 0 };
                products[prod].sales += sales;
                products[prod].qty += qty;

                customers[row[COLS.CUST]] = (customers[row[COLS.CUST]] || 0) + sales;
            });

            // تحديث الواجهة
            document.getElementById('headerName').textContent = selectedRep;
            document.getElementById('totalSales').textContent = totalSales.toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('totalQty').textContent = totalQty.toLocaleString();
            document.getElementById('invoiceCount').textContent = filtered.length;

            // أعلى منطقة وعميل
            const topArea = Object.keys(areas).sort((a,b) => areas[b] - areas[a])[0] || 'لا يوجد';
            document.getElementById('topAreaText').textContent = topArea;

            const topCustEntry = Object.entries(customers).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('topCustomer').textContent = topCustEntry ? topCustEntry[0] : '--';
            document.getElementById('topCustomerVal').textContent = topCustEntry ? Math.floor(topCustEntry[1]).toLocaleString() : '0';

            // الرسوم البيانية
            updateCharts(dates, areas);
            
            // الجداول
            renderTables(products, customers);
        };

        function updateCharts(dateMap, areaMap) {
            // ترتيب التواريخ
            const sortedDates = Object.keys(dateMap).sort((a,b) => parseDate(a) - parseDate(b));
            
            // Chart 1: Sales
            if (charts.sales) charts.sales.destroy();
            charts.sales = new Chart(document.getElementById('salesChart'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'المبيعات',
                        data: sortedDates.map(d => dateMap[d]),
                        backgroundColor: '#2563eb',
                        borderRadius: 6,
                        barThickness: 'flex',
                        maxBarThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });

            // Chart 2: Areas
            if (charts.area) charts.area.destroy();
            const areaLabels = Object.keys(areaMap);
            charts.area = new Chart(document.getElementById('areaChart'), {
                type: 'doughnut',
                data: {
                    labels: areaLabels,
                    datasets: [{
                        data: Object.values(areaMap),
                        backgroundColor: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 15 } } },
                    cutout: '70%'
                }
            });
        }

        function renderTables(prodMap, custMap) {
            // Products Table
            const prodBody = document.getElementById('productsTable');
            prodBody.innerHTML = Object.entries(prodMap)
                .sort((a,b) => b[1].sales - a[1].sales)
                .map(([name, data]) => `
                    <tr class="group hover:bg-slate-50 transition">
                        <td class="px-4 py-3 font-medium text-slate-700">${name}</td>
                        <td class="px-4 py-3 text-center text-slate-500">${data.qty}</td>
                        <td class="px-4 py-3 text-left font-bold text-brand">${Math.floor(data.sales).toLocaleString()}</td>
                    </tr>
                `).join('');

            // Customers Table
            const custBody = document.getElementById('customersTable');
            custBody.innerHTML = Object.entries(custMap)
                .sort((a,b) => b[1] - a[1])
                .map(([name, sales]) => `
                    <tr class="group hover:bg-slate-50 transition">
                        <td class="px-4 py-3 font-medium text-slate-700">${name}</td>
                        <td class="px-4 py-3 text-left font-bold text-slate-600">${Math.floor(sales).toLocaleString()}</td>
                    </tr>
                `).join('');
        }
    </script>
</body>
</html>
